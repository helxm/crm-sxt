/*! ydh-resource-web author:wmao 2014-09-10*/
var THISPAGE={},curRow,curCol;$(function(){Public.Ajax.get({},"/customer/customer?action=listForOrderAddSelect&t="+(new Date).getTime(),!1,function(a){return 200!=a.code?void Public.Ajax.handleResponseText(a):(Bussness.agentInfo=a.data.agentInfo,void(Bussness.productInfo=[]))}),THISPAGE={init:function(a){this.loadGrid(a),this.addEvent(),this.initCombo()},isOrderDeliverDate:"true"==$("#isOrderDeliverDate").val()?!0:!1,isUseProductWeight:"true"==$("#isUseProductWeight").val()?!0:!1,weightUnitName:$("#weightUnitName").val(),exiProduct:!1,isSaving:0,loadGrid:function(a){function b(){var a=$(".productAuto")[0];return a}function c(a,b,c){return"get"===b?""!==$(".productAuto").getCombo().getValue()?$(a).val():"":void("set"===b&&$("input",a).val(c))}function d(){$("#initCombo").append($(".productAuto").val("")).unbind("focus.once")}function e(a){var b=void 0==a?"":a;return""!=b&&parseFloat(a)!=a&&(b='<span class="cellMoney"><i style="text-decoration:line-through;">'+Public.Format.formatCurrency(a.split(",")[0])+'</i><i class="red">'+Public.Format.formatCurrency(a.split(",")[1])+"</i></span>"),""!=b&&parseFloat(a)==a&&(b=Public.Format.formatCurrency(b)),b}function f(a){var b=void 0==a?"":a;return(""!=b||0===b)&&(b=b.toFixed(2)+h.weightUnitName),b}function g(a){var b;return b="add"==a?'<a class="theme-color add-product-remark" href="javascript:void(0)">添加</a>':"view"==a?'<a class="theme-color add-product-remark" href="javascript:void(0)">查看</a>':""}var h=this,i=[{name:"operating",width:50,fixed:!0,formatter:Public.Grid.orderOper,sortable:!1,align:"center"},{name:"productId",hidden:!0},{name:"name",index:"name",width:440,editable:!0,sortable:!1,edittype:"custom",editoptions:{custom_element:b,custom_value:c,handle:d,trigger:"ui-icon-ellipsis"}},{name:"count",index:"count",width:80,align:"center",sortable:!1,editable:!0,editoptions:{"class":"textbox"}},{name:"productUnitName",index:"productUnitName",width:50,align:"center",sortable:!1},{name:"marketPrice",index:"marketPrice",hidden:!0,align:"center",formatter:"currency",formatoptions:{showZero:!0,decimalPlaces:2,prefix:"￥",defaultValue:""},sortable:!1},{name:"orderPrice",index:"orderPrice",hidden:!0,align:"center",formatter:"currency",formatoptions:{showZero:!0,decimalPlaces:2,prefix:"￥",defaultValue:""},sortable:!1},{name:"showPrice",index:"showPrice",width:100,align:"right",formatter:e,sortable:!1},{name:"promotionPrice",index:"promotionPrice",hidden:!0,align:"center",formatter:"currency",formatoptions:{showZero:!0,decimalPlaces:2,prefix:"￥",defaultValue:""},sortable:!1},{name:"money",index:"money",width:150,align:"right",formatter:"currency",sortable:!1,formatoptions:{decimalSeparator:".",thousandsSeparator:",",showZero:!0,decimalPlaces:2,defaultValue:""}},{name:"productRemark",index:"productRemark",width:50,align:"center",sortable:!1,formatter:g}],j=["","productId","商 品","数 量","单位","","","单 价","促 销 价","小 计","备注"];h.isUseProductWeight&&(i.splice(9,0,{name:"weight",width:60,align:"center",formatter:f,sortable:!1}),j.splice(9,0,"重量小计")),$("#order-add").jqGrid({datatype:"clientSide",data:a.entries,mtype:"GET",colNames:j,colModel:i,cellEdit:!0,cellsubmit:"clientArray",cellLayout:10,rowNum:a.entries.length,viewrecords:!0,gridview:!0,autoencode:!0,shrinkToFit:!0,forceFit:!0,autowidth:!0,height:"auto",rownumbers:!0,loadComplete:function(a){h.newId=parseInt($("#order-add").jqGrid("getDataIDs").pop(),10)+1;for(var b=1,c=a.rows.length;c>=b;b++)$("#order-add").jqGrid("setCell",b,"name","",{},{"class":"tip"+b+"-3",title:""}),h._setNameTip(b,{})},afterEditCell:function(a,b,c,d,e){$("#"+d+"_name","#order-add").val(c),h.curID=a,h.iRow=d,h.iCol=e},afterSaveCell:function(a,b,c){switch(b){case"name":{var d=$("#"+a).data("productInfo"),e=$("#order-add").jqGrid("getRowData",a);h._getTaxPercent()}if(d){var f=h._setPromotionMethod(d),g=""==d.spec?"":"【"+d.spec+"】",i=f+d.code+" "+d.name+g,j=h._setShowPrice(d),k=h._setPromotionPrice(d),l=1;d.id==e.productId&&(l=e.count);var m={productId:d.id,name:i,productUnitName:d.productUnitName,marketPrice:d.marketPrice,orderPrice:d.orderPrice,showPrice:j,promotionPrice:k,count:l,weight:d.weight,money:k*l,productRemark:"add"};e.count&&(m.weight=e.count*d.weight,m.money=e.count*k),$("#order-add").jqGrid("setRowData",a,m),h._combineSameRows(d.id,a),h.calTotal(),$("#"+a).data().hasOwnProperty("productInfo")?(h._setNameTip(a,d),1==Bussness.isUseInventory&&h._setInventoryTip(a,d)):h._setNameTip(a,{})}break;case"count":var e=$("#order-add").jqGrid("getRowData",a),k=e.promotionPrice,n=parseFloat(c);isNaN(n)&&($("#order-add").jqGrid("setRowData",a,{count:1}),n=1),parseFloat(n).toFixed(2)<=0&&($("#order-add").jqGrid("setRowData",a,{count:1}),n=1),n>1e8&&($("#order-add").jqGrid("setRowData",a,{count:1e8}),n=1e8);var e=$("#order-add").jqGrid("getRowData",a),i=e.name,d=$("#"+a).data("productInfo");if(""==i)$("#order-add").jqGrid("setRowData",a,{count:""});else{-1!=n.toString().indexOf(".")&&n.toString().split(".")[1].length>2&&(n=parseFloat(n).toFixed(2),$("#order-add").jqGrid("setRowData",a,{count:n}));var o=$("#order-add").jqGrid("setRowData",a,{money:n*k,weight:n*d.weight});o&&h.calTotal(),h._setInventoryTip(a,d)}}}})},_setAgentTip:function(){Public.Ui.Tip.setTip($(".agentAuto"),{content:"先选择"+$("#customerName").val(),show:{ready:!0},position:{my:"left middle",at:"right center"}})},_setDiscountTip:function(){Public.Ui.Tip.setTip($(".discount-tip"),{content:{text:"特价单必须在已经获得特价审批批准前提下勾选，并填写获批特价后的订单金额，<br />并需在订单备注中填写申请原因和审批人。如之前未获批准，请不要勾选本项"}})},_setNameTip:function(a,b){if($.isEmptyObject(b))Public.Ui.Tip.setTip($(".tip"+a+"-3"),{content:"点击选择商品"});else{var c=this,d=c._setPromotionMethod(b),e=""==b.spec?"":"【"+b.spec+"】",f=d+b.code+" "+b.name+e,g=f,h=c._setPromotionInfo(b);productNameTip=g+"<br/>"+h,$("#order-add").jqGrid("setCell",a,"name","",{},{"class":"tip"+a+"-3",title:""}),Public.Ui.Tip.setTip($(".tip"+a+"-3"),{content:productNameTip})}},_setInventoryTip:function(a,b){$("#order-add").jqGrid("setCell",a,"count","",{},{"class":"tip"+a+"-4",title:""});var c=$("#order-add").jqGrid("getRowData",a),d=c.count,e="";""!=b.inventoryCount?(e=b.inventoryCount,b.inventoryCount-b.prepareCount-d<0&&$("#order-add").jqGrid("setCell",a,"count","","red"),e="现库存："+e+"，预购："+b.prepareCount):e="无库存信息！",Public.Ui.Tip.setTip($(".tip"+a+"-4"),{content:e})},_setPromotionMethod:function(a){var b="";return a.promotionInfo.hasOwnProperty("method")&&(b="【促销】"),b},_setPromotionInfo:function(a){var b="";return a.promotionInfo.hasOwnProperty("method")&&(1==a.promotionInfo.method&&(b='促销信息:<i class="ui-icon-promotion-method method1">买赠</i> 订购每满'+a.promotionInfo.meetCount+"获赠品"+a.promotionInfo.giftProductCount+a.productUnitName+"，赠品：”"+a.promotionInfo.giftProductName+"”"),2==a.promotionInfo.method&&(b='促销信息:<i class="ui-icon-promotion-method method2">直降</i> 订货价降至'+a.promotionInfo.promotionMoney+"元"),3==a.promotionInfo.method&&(b='促销信息:<i class="ui-icon-promotion-method method3">打折</i> 在原订货价基础上再打 '+parseFloat(a.promotionInfo.promotionDiscount.toString().movePointRight(1))+"折")),b},_setShowPrice:function(a){var b=this,c=b._getTaxPercent(),d=(a.orderPrice*c).toString().movePoint(-2);return 1==a.promotionInfo.method&&(d=(a.orderPrice*c).toString().movePoint(-2)),2==a.promotionInfo.method&&(promotionPrice=(a.promotionInfo.promotionMoney*c).toString().movePoint(-2),d=(a.orderPrice*c).toString().movePoint(-2)+","+promotionPrice),3==a.promotionInfo.method&&(promotionPrice=(a.promotionInfo.promotionDiscount.toString().movePoint(2)*a.orderPrice.toString().movePoint(2)*c).toString().movePoint(-6),d=(a.orderPrice*c).toString().movePoint(-2)+","+promotionPrice),d},_setPromotionPrice:function(a){var b=this,c=b._getTaxPercent(),d=a.orderPrice;return 2==a.promotionInfo.method&&(d=a.promotionInfo.promotionMoney),3==a.promotionInfo.method&&(d=(a.promotionInfo.promotionDiscount.toString().movePoint(2)*a.orderPrice.toString().movePoint(2)).toString().movePoint(-4)),(d*c).toString().movePoint(-2)},doResize:function(){$("#order-add").setGridWidth($(".grid-wrap").width()-1)},addEvent:function(){var a=this;Public.Order.event(THISPAGE),$(window).resize(function(){a.doResize()}),a.doResize(),$(".save").click(function(b){!$(b.target).closest(".ui-jqgrid-bdiv").length>0&&"undefined"!=typeof curRow&&"undefined"!=curCol&&null!==curRow&&null!==curCol&&($("#order-add").jqGrid("saveCell",curRow,curCol),curRow=null,curCol=null);var c=a.getPostData();c&&!a.isSaving?(c.submitType="ajax",$.ajax({url:"/order/order?action=add",data:c,type:"POST",dataType:"json",async:!0,beforeSend:function(){a.isSaving=1,$("html").mask("正在提交数据。")},success:function(b){return 200!=b.code?(Public.Ajax.handleResponseText(b),void(a.isSaving=0)):($.dialog.tips("订单："+b.data.orderNum+"添加成功",1.5,"success.gif",function(){window.location.href="/order/order?action=list"}),void $("html").unmask())},error:function(){$.dialog.alert("系统繁忙，请稍后再试！"),a.isSaving=0}})):$.dialog.alert("有订单正在提交中！")}),$(".add-product-remark").die("click").live("click",function(){var a=$(this).parents("tr")[0].id;$.dialog({data:{remark:$("#"+a).data("productInfo").hasOwnProperty("productRemark")?$("#"+a).data("productInfo").productRemark:"",callback:function(b,c){$("#"+a).data("productInfo").productRemark=b.remark,$("#order-add").jqGrid("setRowData",a,{productRemark:"view"}),c&&c.api.close()}},content:"url:../alert/productRemarkAdd.jsp",title:"添加商品备注",width:480,height:200,lock:!0,ok:function(){return this.content.callback(),!1},cancel:!0})}),a._setDiscountTip();var b=($(".chks").cssCheckbox({callback:function(b){"isDiscountOrder"==b.name&&(b.checked?($("#inp-discount-order").removeClass("ui-input-line-dis").removeAttr("disabled")[0].focus(),a.calTotal()):($("#inp-discount-order").addClass("ui-input-line-dis").attr("disabled","disabled"),$("#inp-discount-order").val(""),a.calTotal())),"isUseBackPoint"==b.name&&(b.checked?($(".is-use-back-point-con").show(),$("#inp-back-point-account").removeClass("ui-input-line-dis").removeAttr("disabled")):($(".is-use-back-point-con").hide(),$("#inp-back-point-account").addClass("ui-input-line-dis").attr("disabled","disabled")))}}),$(".choose-invoice-type").cssRadio({callback:function(){var c=b.getValue();0==c?($(".control-group-invoice-info").hide(),$(".total-money-label").html("合计："),$(".total-rel-money-label").html("应付总额：")):($(".control-group-invoice-info").show(),1==c?($(".invoiceType1").show(),$(".invoiceType2").hide(),$(".total-money-label").html("合计（含税）："),$(".total-rel-money-label").html("应付总额（含税）：")):2==c&&($(".invoiceType1").show(),$(".invoiceType2").show(),$(".total-money-label").html("合计（含税）："),$(".total-rel-money-label").html("应付总额（含税）："))),a.exiProduct&&a._resetRowsByTaxVal()}}));!function(){var a=b.getValue();0!=a&&($(".total-money-label").html("合计（含税）："),$(".total-rel-money-label").html("应付总额（含税）："))}(),$(".grid-wrap").on("click",".ui-icon-ellipsis",function(){$.dialog({width:950,height:500,title:"选择商品",content:"url:../alert/productBatch.jsp",data:{curID:a.curID,rows:a.newId-1,iCol:a.iCol,agentId:a.agentCombo.getValue(),callback:function(){}},cache:!1,lock:!0,ok:function(){this.content.callback()},cancel:!0})}),$("#inp-discount-order").blur(function(){var b=Public.Format.clear($.trim($(this).val()));if($("input[name='isDiscountOrder']").length>0&&$("input[name='isDiscountOrder']")[0].checked&&!Public.Validate.positive(b))$.dialog.alert("特价金额只能为非负数"),$(this).val("");else{var c=""!=$(this).val()?Public.Format.formatCurrency($(this).val()):"";$(this).val(c),a.calTotal()}}),$("#inp-discount-order").keyup(function(a){13==a.keyCode&&$(".save").focus()}),$("#inp-discount-order").focus(function(){var a=""!=$(this).val()?Public.Format.clear($(this).val()):"";$(this).val(a)}),$("#address-edit").click(function(){$.dialog({data:{addressId:$(".addressId").val(),customerId:a.agentCombo.getValue(),oper:"add",callback:function(a,b){var c=$(".address-info");c.find(".addressId").val(a.id),c.find(".contactor").text(a.contact),c.find(".mobile").text(a.mobile),c.find(".address").text(a.countryName+a.provinceName+a.cityName+a.districtName+a.address),b&&b.api.close()}},content:"url:../alert/addressManage.jsp?customerId="+a.agentCombo.getValue(),title:"修改收货信息",width:760,zIndex:1900,height:456,lock:!0,ok:function(){return this.content.callback(),!1},cancel:!0})}),$("#invoice-edit").click(function(){$.dialog({data:{type:"add",invoice:{isAddValueInvoice:$("#isAddValueInvoice").val(),invoiceType:parseInt($("input[name='invoiceType']:checked").val(),10),isUsetax:$("#isUsetax").val(),taxRate:$("input[name='invoiceType']:checked").next("input[name='taxVal']").val(),invoice:$(".invoice").text(),invoiceContent:$(".invoiceContent").text(),bank:$(".bank").text(),bankAccount:$(".bankAccount").text(),taxNum:$(".taxNum").text()},callback:function(a,b){var c=$(".invoice-info");1==a.invoiceType&&(c.find(".invoiceType").text("普通发票"),$(".invoiceType1").show(),$(".invoiceType2").hide()),2==a.invoiceType&&(c.find(".invoiceType").text("增值税发票"),$(".invoiceType1").show(),$(".invoiceType2").show()),3==a.invoiceType&&(c.find(".invoiceType").text("不开发票"),$(".invoiceType1").hide(),$(".invoiceType2").hide()),c.find(".invoice").text(a.invoice),c.find(".invoiceContent").text(a.invoiceContent),c.find(".bank").text(a.bank),c.find(".bankAccount").text(a.bankAccount),c.find(".taxNum").text(a.taxNum),b&&b.api.close()}},content:"url:../alert/invoiceEdit.jsp",title:"修改发票信息",width:550,height:256,lock:!0,ok:function(){return this.content.callback(),!1},cancel:!0})});var c=(new Date).Format("yyyy-M-d");$("#deliveryDate").datepicker("option","minDate",c)},initCombo:function(){var a=this;a.agentCombo=Public.Ui.Combo.agentCombo($("#agentAuto"),{data:function(){return Bussness.agentInfo},callback:{onChange:function(b){$(".agentAuto").qtip("destroy",!0),a.customerId!=a.agentCombo.getValue()&&(a.oldCustomerId=a.customerId),a.customerId=a.agentCombo.getValue(),a.exiProduct?$.dialog.confirm("是否确定修改客户？修改客户后，将清除已选择的商品数据。",function(){a.clearTable(),b&&(a.getAgentProduct(b.id),a.getOrderPromotion(b.id))},function(){a.agentCombo.loadData(Bussness.agentInfo,["id",a.oldCustomerId])}):b&&(a.getAgentProduct(b.id),a.getOrderPromotion(b.id));var c=b&&b.hasOwnProperty("addressInfo")?b.addressInfo:{},d=$(".address-info");$.isEmptyObject(c)||(d.find(".addressId").val(c.id),d.find(".contactor").text(c.contactor),d.find(".mobile").text(c.mobile),d.find(".address").text(c.countryName+c.provinceName+c.cityName+c.districtName+c.address));var e=$(".invoice-info");e.find("input[name='invoiceType']").val(1),e.find(".invoiceType").text("普通发票"),e.find(".invoice").text(b?b.invoice:""),e.find(".invoiceContent").text("商品明细"),e.find(".bank").text(b?b.bank:""),e.find(".bankAccount").text(b?b.bankAccount:""),e.find(".taxNum").text(b?b.taxNum:""),d.show(),e.show()},onBlur:function(){a.customerId!=a.agentCombo.getValue()&&(a.oldCustomerId=a.customerId),a.customerId=a.agentCombo.getValue(),""==this.input.val()&&(a._setAgentTip(),$(".address-info").hide(),$(".invoice-info").hide(),a.exiProduct&&$.dialog.confirm("是否确定修改客户？修改客户后，将清除已选择的商品数据。",function(){a.clearTable()},function(){a.agentCombo.loadData(Bussness.agentInfo,["id",a.oldCustomerId])}),$("#orderPromotionMeetMoney").text(""),$(".order-promotion").hide(),a.getAgentProduct(0))}}},{data:{callback:function(b,c){a.agentCombo.loadData(Bussness.agentInfo,["id",b]),c&&c.api.close()}},ok:function(){return this.content.callback(),!1}}),a._setAgentTip(),a.productCombo=Public.filterProduct($(".productAuto"),{data:function(){var a=Bussness.productInfo;return a},formatText:function(b){var c=a._setPromotionMethod(b),d=""==b.spec?"":"【"+b.spec+"】";return c+b.code+" "+b.name+d},callback:{onChange:function(b){if(b){var c=this.input.parents("tr");c.data("productInfo",b);var d=a._setPromotionMethod(b),e=""==b.spec?"":"【"+b.spec+"】";this.input.val(d+b.code+" "+b.name+e)}}}})},getOrderPromotion:function(a){Public.Ajax.get({customerId:a},"/product/promotion?action=getAvailableOrderPromotion&t="+(new Date).getTime(),!1,function(a){return 200!=a.code?void Public.Ajax.handleResponseText(a):(Bussness.orderPromotion=a.data.orderPromotion,void($.isEmptyObject(Bussness.orderPromotion)?($("#orderPromotionMeetMoney").text(""),$(".order-promotion").hide()):($("#orderPromotionMeetMoney").text(Bussness.orderPromotion.meetMoney),$(".order-promotion").show())))})},clearTable:function(){for(var a=this,b=$("#order-add").jqGrid("getDataIDs"),c=0,d=b.length;d>c;c++){var e=b[c],f={productId:"",name:"",marketPrice:"",orderPrice:"",showPrice:"",promotionPrice:"",count:"",productUnitName:"",money:"",productRemark:""};$("#order-add").jqGrid("setRowData",e,f),$("#"+e).removeData("productInfo"),$(".tip"+e+"-3").qtip("destroy",!0),$(".tip"+e+"-4").qtip("destroy",!0)}a.calTotal()},_getTaxPercent:function(){var a=100;return 1==$("#isUsetax").val()&&(a+=parseInt($("input[name='invoiceType']:checked").next("input[name='taxVal']").val(),10)),a},_resetRowsByTaxVal:function(){for(var a=this,b=(a._getTaxPercent(),$("#order-add").jqGrid("getDataIDs")),c=0,d=b.length;d>c;c++){var e=b[c],f=$("#order-add").jqGrid("getRowData",e);if(f.name){var g={};productInfo=$("#"+e).data("productInfo"),g.showPrice=a._setShowPrice(productInfo),g.promotionPrice=a._setPromotionPrice(productInfo),g.money=g.promotionPrice*f.count,$("#order-add").jqGrid("setRowData",e,g)}}a.calTotal()},getAgentProduct:function(a){var b=this;0==a?b.hasOwnProperty("productCombo")&&b.productCombo.loadData([]):$.ajax({url:"/product/product?action=listForOrderAddSelect",data:{customerId:a,submitType:"ajax"},type:"GET",dataType:"json",async:!0,beforeSend:function(){$("html").mask("正在载入数据...")},success:function(a){return 200!=a.code?void Public.Ajax.handleResponseText(a):(Bussness.isUseInventory=a.data.isUseInventory,Bussness.productInfo=a.data.productInfo,$("#quickChooseProduct").html(Bussness.productInfo.length<500?'<i class="ui-icon-choose"></i>选择商品':'<i class="ui-icon-choose"></i>从全部商品中选择'),b.productCombo.loadData(Bussness.productInfo),void $("html").unmask())},error:function(){$.dialog.alert("系统繁忙，请稍后再试！")}})},calTotal:function(){var a=this,b=Bussness.orderPromotion,c=[],d=$("#order-add").jqGrid("getDataIDs"),e=0,f=0,g=0;$(".product-promotion").find(".ready").remove();for(var h=0,i=d.length;i>h;h++){var j=d[h],k=$("#order-add").jqGrid("getRowData",j);k.name&&c.push($("#"+j).data("productInfo").promotionInfo)}for(var h=0,i=d.length;i>h;h++){var j=d[h],k=$("#order-add").jqGrid("getRowData",j);if(k.name){a.exiProduct=!0;break}a.exiProduct=!1}for(var h=0,i=d.length;i>h;h++){var j=d[h],k=$("#order-add").jqGrid("getRowData",j);k.name&&(f+=parseFloat(k.count*k.promotionPrice),k.weight&&(e+=parseFloat(k.weight.split(a.weightUnitName)[0])),c.length>0&&$.each(c,function(b,c){if(c.promotionProductId==k.productId){if(1==c.method&&parseInt(k.count/c.meetCount,10)>0){var d={};d.giftProductId=c.giftProductId,d.giftProductCode=c.giftProductCode,d.giftProductName=c.giftProductName,d.giftProductCount=c.giftProductCount,d.giftProductSpec=c.giftProductSpec,d.giftProductUnit=c.giftProductUnit,d.count=parseInt(k.count/c.meetCount,10)*d.giftProductCount,a._showGift(d)}return 2==c.method,void(3==c.method)}}))}var l=$(".order-total");if(l.find(".total-money").text(Public.Format.formatCurrency(f)),l.find(".total-weight").text(e.toFixed(2)),g=$("input[name='isDiscountOrder']").length>0&&$("input[name='isDiscountOrder']")[0].checked?$("#inp-discount-order").val():f,l.find(".total-rel-money").text(Public.Format.formatCurrency(g)),b&&0!=parseFloat(b.meetMoney)&&Public.Format.clear(g)>=parseFloat(b.meetMoney)){var m={};m.giftProductCount=b.giftProductCount,m.count=parseInt(Public.Format.clear(g)/parseFloat(b.meetMoney),10)*m.giftProductCount,m.giftProductId=b.giftProductId,m.giftProductCode=b.giftProductCode,m.giftProductName=b.giftProductName,m.giftProductSpec=b.giftProductSpec,m.giftProductUnit=b.giftProductUnit,a._showGift(m)}var n=parseInt(d.pop(),10),o=$("#order-add").jqGrid("getRowData",n);""!=o.productId&&($("#order-add").jqGrid("addRowData",a.newId,{},"last"),$("#order-add").jqGrid("setCell",a.newId,"name","",{},{"class":"tip"+a.newId+"-3",title:""}),a._setNameTip(a.newId,{}),a.newId++),a.doResize()},_showGift:function(a){if($(".product-promotion").find("input[value="+a.giftProductId+"]").length>0){var b=$(".product-promotion").find("input[value="+a.giftProductId+"]").parents("li");a.count=parseInt(b.find(".count").text(),10)+a.count,b.find(".count").html(a.count)}else{var c=$(".product-promotion").find(".template:first-child").clone();c.find(".productId").val(a.giftProductId),c.find(".code").html(a.giftProductCode),c.find(".name").html(a.giftProductName);var d=""==a.giftProductSpec?"":"("+a.giftProductSpec+")";c.find(".spec").html(d),c.find(".unit").html(a.giftProductUnit),c.find(".count").html(a.count),c.removeClass("tempate").addClass("ready").show().appendTo($(".product-promotion > ul"))}},_getEntriesData:function(){for(var a=[],b=$("#order-add").jqGrid("getDataIDs"),c=0,d=b.length;d>c;c++){var e,f=b[c],g=$("#order-add").jqGrid("getRowData",f);""!==g.name&&(e={productId:g.productId,marketPrice:g.marketPrice,price:g.orderPrice,count:g.count,money:g.money,productRemark:$("#"+f).data("productInfo").hasOwnProperty("productRemark")?$("#"+f).data("productInfo").productRemark:""},a.push(e))}return a},_getAttachment:function(){var a=[];return $.each($(".attachment-list").find(".ready"),function(b,c){var d=$(c).find(".file-server").val(),e=$(c).find(".file-name").text();a.push({attachment:d,fileName:e})}),a},_combineSameRows:function(a,b){for(var c=this,d=$("#order-add").jqGrid("getDataIDs"),e=0,f=d.length;f>e;e++){var g=d[e],h=$("#order-add").jqGrid("getRowData",g);if(""!==h.name&&a==h.productId&&b!=g){var i={productId:"",name:"",marketPrice:"",orderPrice:"",showPrice:"",promotionPrice:"",count:"",productUnitName:"",money:"",productRemark:"",weight:""};$("#order-add").jqGrid("setRowData",b,i),$("#"+b).removeData("productInfo");var j=Number(h.count)+1,k=h.promotionPrice;$("#order-add").jqGrid("setRowData",g,{count:j,money:j*k,weight:j*parseFloat(h.weight)/h.count}),c.calTotal(),$.dialog.tips("重复商品已经合并，并且数量 +1",1)}}},getPostData:function(){var a=this,b=a.agentCombo.getValue();if(""===b||0===b)return $.dialog.alert($("#customerName").val()+"信息不能为空"),!1;var c=a._getEntriesData();if(c.length>0){var d=[];if(a.isOrderDeliverDate&&""==$("#deliveryDate").val())return $.dialog.alert("交货日期不能为空"),!1;if(""==$("input.addressId").val())return $.dialog.alert("请选择地址信息！"),!1;if($("input[name='isDiscountOrder']").length>0&&$("input[name='isDiscountOrder']")[0].checked&&""==$.trim($("#inp-discount-order").val()))return $.dialog.alert("您已申请特价，请填写特价金额"),!1;if($("input[name='isDiscountOrder']").length>0&&$("input[name='isDiscountOrder']")[0].checked&&""==$.trim($("textarea.inp-remark").val()))return $.dialog.alert("为加快审批流程，建议在备注中说明特价申请原因和审批简要！"),!1;var e=0!=$("input[name='invoiceType']:checked").val()?!1:!0,f={customerId:b,invoiceType:$("input[name='invoiceType']:checked").val(),isNotInvoice:e,invoice:$(".invoice").text(),invoiceContent:$(".invoiceContent").text(),bank:$(".bank").text(),bankAccount:$(".bankAccount").text(),taxNum:$(".taxNum").text(),productEntries:$.toJSON(c),addressId:$("input.addressId").val(),remark:$("textarea.inp-remark").val(),useBackPoint:$("#inp-back-point-account").val(),isDiscountOrder:$("input[name='isDiscountOrder']").length>0&&$("input[name='isDiscountOrder']")[0].checked?1:0,discountMoney:Public.Format.clear($("#inp-discount-order").val()),attachmentEntries:$.toJSON(d),deliveryDate:$("#deliveryDate").val()};return f}return $.dialog.alert("商品不能为空！"),!1}};THISPAGE.showData={id:-1,status:"add",customerId:0,entries:[{id:"1"},{id:"2"},{id:"3"}],totalMoney:0,totalPriviledges:0,totalRebate:0,totalRelMoney:0,remark:"",addressId:-1},THISPAGE.init(THISPAGE.showData)});