/*! ydh-resource-web author:wmao 2014-08-27*/
!function(a){a.fn.productTypeCombo=function(b){b=a.extend(!0,a.fn.productTypeCombo.options,b);var c={productTypeData:null},d={typeData:null,getTempHtml:{getDropListWrap:function(){var b='<div class="ui-droplist-wrap" style="display:none;"><div class="droplist type-info" style="overflow: auto;"></div></div>';return a(b)},item:function(){var b='<div class="item"><em></em><a class="name" href="javascript:void(0)"></a><input type = "hidden" class="type-id" /></div> ';return a(b)},itemCon:function(){var b='<div class="item-con" style="display:none;"></div>';return a(b)}},getNode:function(a,b,c){for(var d=c[b],e=null,f=0,g=d.length;g>f;f++)if(d[f].id==a){e=d[f];break}return e},initLevelOne:function(c,e,f){var g=this,h=f[1];a(e).css({width:b.width-2}),a(e).find("input.name").css({width:b.width-42});var i=d.getTempHtml.getDropListWrap();b.extraHTML&&i.append(a(b.extraHTML));d.getStyle.getInputStyle(e);i.css({position:"absolute",width:b.width-2}),a(e).after(i);for(var j=i.find(".droplist"),k=0,l=h.length;l>k;k++){var m=h[k],n=g.setItem(m);j.append(n)}},setChild:function(b,e){var f=this,g=a("input.type-id[value="+e+"]").parents(".item"),h=g.data("typeInfo");if(!h.isAdded){for(var i=c.productTypeData[h.typeLevel+1],j=[],k=0,l=i.length;l>k;k++)i[k].parentTypeId==e&&j.push(i[k]);var m=d.getTempHtml.itemCon();g.after(m),h.isAdded=!0;for(var n=0,l=j.length;l>n;n++){var o=j[n],p=f.setItem(o);m.append(p)}}g.find("em").removeClass("em_open").addClass("em_close"),g.next(".item-con").eq(0).show()},setItem:function(a){var b=d.getTempHtml.item();return b.find("em").css({marginLeft:21*(a.typeLevel-1)}),b.find("em").addClass(1==a.leafTypeFlag?"em_leaf":"em_open"),a.isAdded=!1,b.data("typeInfo",a),b.find(".name").text(a.name),b.find(".type-id").val(a.id),b},addEvent:function(c,d){var e=this;a(document).on("click",function(c){var f=c.target||c.srcElement,g=a(d).next(".ui-droplist-wrap"),h=g.find(".droplist");if(0==a(f).closest(h).length&&0==a(f).closest(g).length)1==a(f).closest(a(d)).length?"none"!=a(d).next().css("display")?g.hide():a(f.parentElement).hasClass("ui-combo-disabled")||g.show():g.hide();else{var i=f.className;switch(i){case"item":var j=a(f);b.isOnlyLeaf?a.isEmptyObject(j.data("typeInfo"))||1==j.data("typeInfo").leafTypeFlag?(a(d).find("input.name").val(a(f).find(".name").text()),a(d).find("input.cur-id").val(a(f).find(".type-id").val()),g.hide()):alert(b.isOnlyLeafTxt):(a(d).find("input.name").val(a(f).find(".name").text()),a(d).find("input.cur-id").val(a(f).find(".type-id").val()),g.hide()),b.callback.nameClick(j);break;case"em_open":var k=(a(f).parents(".item").find(".parent-type-id").val(),a(f).parents(".item").find(".type-id").val()),l=a(f).parents(".item").find(".type-level").val();e.setChild(l,k),a("input.type-id[value="+k+"]").parents(".item").siblings(".item").find("em.em_close").trigger("click");break;case"em_close":var k=a(f).parents(".item").find(".type-id").val();a("input.type-id[value="+k+"]").parents(".item").next(".item-con").hide(),a(".parent_"+k).children("em.em_close").trigger("click"),a(f).addClass("em_open").removeClass("em_close");break;case"name":var j=a(f).parents(".item");b.isOnlyLeaf?a.isEmptyObject(j.data("typeInfo"))||1==j.data("typeInfo").leafTypeFlag?(a(d).find("input.name").val(a(f).text()),a(d).find("input.cur-id").val(a(f).parents(".item").find(".type-id").val()),g.hide()):alert(b.isOnlyLeafTxt):(a(d).find("input.name").val(a(f).text()),a(d).find("input.cur-id").val(a(f).parents(".item").find(".type-id").val()),g.hide()),b.callback.nameClick(j)}}})},initCurrentType:function(){var d=(b.curId,c.productTypeData),e=null,f=[];for(var g in d)for(var h=0,i=d[g].length;i>h;h++)d[g][h].id==b.curId&&(e=d[g][h]);if(!a.isEmptyObject(e)){f.unshift(e.parentTypeId);for(var j={level:e.typeLevel,id:e.id,parentTypeId:e.parentTypeId};j.level>1;)for(var k=0,l=d[j.level-1].length;l>k;k++)if(d[j.level-1][k].id==j.parentTypeId){j.id=d[j.level-1][k].id,j.parentTypeId=d[j.level-1][k].parentTypeId,j.level=d[j.level-1][k].typeLevel,f.unshift(j.parentTypeId);break}for(var m=0,n=f.length;n>m;m++)a("input.type-id[value="+f[m]+"]").parents(".item").find("em.em_open").trigger("click"),a("input.type-id[value="+b.curId+"]").parents(".item").find(".name").addClass("selected");return e}},getStyle:{getInputStyle:function(a){var b={};return b.left=a.offsetLeft,b.top=a.offsetTop,b.width=a.clientWidth,b.height=a.clientHeight,b}}};return this.each(function(e,f){a.ajax({url:b.url+"&t="+(new Date).getTime(),type:"get",dataType:"JSON",async:!0,beforeSend:function(){a("html").mask("正在载入数据...")},success:function(g){if(200==g.code){if(c.productTypeData=g.data,a.isEmptyObject(c.productTypeData))a("html").unmask();else if(a(f).data("typeData",g.data),d.initLevelOne(e,f,c.productTypeData),d.addEvent(e,f),b.curId){var h=d.initCurrentType(b.curId);a.isEmptyObject(h)||(a(f).find("input.name").val(h.name),a(f).find("input.cur-id").val(b.curId))}b.callback.complete()}else alert("获取商品分类数据失败，请联系管理员！");a("html").unmask()},error:function(){a("html").mask("正在载入数据..."),alert("获取商品分类数据失败，请刷新页面重试！")}})})},a.fn.productTypeCombo.f=function(){alert("S")},a.fn.productTypeCombo.options={url:"/product/type?action=queryTypeTree",curId:0,width:200,isOnlyLeaf:!1,isOnlyLeafTxt:"因本分类下有子分类，商品不能移动至此，请选择此分类的子分类或其他分类！",extraHTML:!1,url:"/product/type?action=queryTypeTree",callback:{nameClick:function(){},complete:function(){}}}}(jQuery);