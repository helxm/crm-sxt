/*! ydh-resource-web author:wmao 2014-08-19*/
var THISPAGE={};$(function(){THISPAGE={init:function(){this.addEvent()},offlineEvent:function(){var a=this;$(".ui-datepicker-inp").attr("readonly",!0),$(".datepickerStart").datepicker({onChangeMonthYear:function(a,b,c){var d=c.selectedDay,e=new Date(a,b-1,d).Format("yyyy-MM-dd");$(".datepickerEnd").datepicker("option","minDate",e),$(this).datepicker("setDate",new Date(a,b-1,d))},changeMonth:!0,changeYear:!0,monthNames:["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"],monthNamesShort:["1","2","3","4","5","6","7","8","9","10","11","12"],dayNames:["星期日","星期一","星期二","星期三","星期四","星期五","星期六"],dayNamesShort:["周日","周一","周二","周三","周四","周五","周六"],dayNamesMin:["日","一","二","三","四","五","六"],dateFormat:"yy-mm-dd",onSelect:function(){}}),$("#bankAccountEdit").die("click").live("click",function(){var a=$(this).parents(".pay-off-line");$.dialog({data:{bankAccountId:a.find(".bank-account-id"),callback:function(b,c){a.find(".bank-account-id").val(b.id),a.find(".bankAccountName").val(b.bankName),a.find(".bankName").val(b.bank),a.find(".bankAccount").val(b.bankAccount),c&&c.api.close()}},content:"url:../alert/bankAccountChoose?action=queryCompanyBank",title:"选择收款银行账号",width:550,height:250,lock:!0,ok:function(){return this.content.callback(),!1},cancel:!0})}),$("#orderPayFileUpload").fileupload({url:"/alert/paymentAttachmentUpload?action=upload",dataType:"json",add:function(a,b){var c=!0,d=b.files[0];/\.(png|jpg|jpeg|doc|docx|xls|xlsx|txt)$/i.test(d.name)||($.dialog.alertNoModel("仅支持JPG\\PNG\\Word\\Excel\\Txt格式附件上传！"),c=!1),d.size>4e6&&($.dialog.alertNoModel("上传附件超过4M，请压缩后再上传！"),c=!1),1==c&&b.submit()},done:function(a,b){if(200==b.result.code){var c=b.result.data,d=$(this).parents(".pay-off-line");d.find("input[name=attachmentSize]").val(c.attachmentSize),d.find("input[name=fileName]").val(c.fileName),d.find("input[name=attachmentName]").val(c.attachmentName),d.find(".pay-attachment").find(".file-name").text(c.fileName),d.find(".pay-attachment").find(".file-size").text("（"+c.attachmentSize+"KB）"),d.find(".pay-attachment").find(".attachment-name").val(c.attachmentName),d.find(".pay-attachment").show(),$.dialog.tips("附件上传成功",1,"success.gif")}else Public.Ajax.handleResponseText(b.result,parent)},progressall:function(a,b){var c=parseInt(b.loaded/b.total*100,10);$(".pay-off-line").find(".progress-txt").text(c+"%")}}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?void 0:"disabled"),$(".file-delete").die("click").live("click",function(){var a=$(this).parents(".pay-off-line");a.find(".file-name").text(""),a.find(".file-size").text(""),a.find(".attachment-name").val(""),a.find("input[name=attachmentSize]").val(""),a.find("input[name=fileName]").val(""),a.find("input[name=attachmentName]").val(""),a.find(".pay-attachment").hide()}),$("#save_payment").die("click").live("click",function(){var b=a.getPostData($(this));b&&(b.submitType="ajax",$.ajax({url:"/pay/payment?action=save",data:b,type:"POST",dataType:"JSON",success:function(a){200==a.code?$.dialog.tips("添加付款记录成功",1,"success.gif",function(){window.location.reload()}):$.dialog.alert(a.message)},error:function(){}}))})},addEvent:function(){var a=this;$("#payMoney").die("blur").live("blur",function(){a.validPayMoney($(this))}),$(".slide-up").die("click").live("click",function(){$(".order-paying").removeClass("order-paying"),$(".pay-tr-prev").removeClass("pay-tr-prev"),$("#payTr").slideUp().remove()}),$(".order-pay").click(function(){var b={submitType:"ajax",orderNum:$(this).parents("tr").find(".order-num").val()},c=$(this).parents("tr");$.ajax({url:"/pay/payment?action=queryPaidMoney",data:b,type:"POST",dataType:"JSON",beforeSend:function(){$("html").mask("正在获取订单付款数据")},success:function(b){if(200==b.code){if($("html").unmask(),0==$("#payTr").length){var d=$("#payCon").html();c.prev("tr").addClass("pay-tr-prev"),c.addClass("order-paying").after(d),$(".pay-con").slideDown()}else if(0!=$("#payTr").length&&0==c.next("#payTr").length){$("#payTr").remove(),$(".order-paying").removeClass("order-paying"),$(".pay-tr-prev").removeClass("pay-tr-prev"),c.prev("tr").addClass("pay-tr-prev");var d=$("#payCon").html();c.addClass("order-paying").after(d),$(".pay-con").slideDown()}$(".pay-con").find("#payMoney").val(Number(b.data.unPaidMoney).toFixed(2)),$(".pay-con").find("span.order-remain-money").text(Number(b.data.unPaidMoney).toFixed(2)),$(".pay-con").find("input.order-remain-money").val(Number(b.data.unPaidMoney).toFixed(2)),$(".pay-con").find("span.order-payed-money").text(Number(b.data.paidMoney).toFixed(2)),htmlCon=$("#payOffLine").html();var e={};$.get("/tpl/pay/payOffline.tpl?t="+(new Date).getTime(),function(b){b=Handlebars.compile(b);var c=b(e);$(".pay-box").html(c),$("#payMoney").val($(".pay-con").find("input.order-remain-money").val()),a.offlineEvent()})}else Public.Ajax.handleResponseText(b),$("html").unmask()},error:function(){$.dialog.alert("系统繁忙，请稍后再试！"),$(".order-paying").removeClass("order-paying"),$("#payTr").remove(),$("html").unmask()}})})},validPayMoney:function(a){{var b=a.parents(".pay-con").find("#payMoney").val(),c=b;a.parents(".pay-con").find("input.order-remain-money").val()}return parseFloat(b)!=b?($.dialog.alert("您输入的金额不正确"),c=!1,!1):(b.split(".")[1]&&b.split(".")[1].length>2&&(a.parents(".pay-con").find("#payMoney").val(Number(b).toFixed(2)),c=a.parents(".pay-con").find("#payMoney").val()),c)},getPostData:function(a){var b=this;if(b.validPayMoney(a)){var c=a.parents(".pay-off-line"),d={orderNum:$(".order-paying").find(".order-num").val(),payMethod:"1",remark:c.find("#remark").val(),payTime:c.find("#payTime").val(),payMoney:c.find("#payMoney").val(),bankAccount:c.find("#bankAccount").val(),bankAccountName:c.find("#bankAccountName").val(),bankName:c.find("#bankName").val(),attachmentName:c.find("input[name=attachmentName]").val(),fileName:c.find("input[name=fileName]").val(),attachmentSize:c.find("input[name=attachmentSize]").val()};return""==d.payTime?($.dialog.alert("付款时间不能为空！"),!1):""==d.bankAccount?($.dialog.alert("请选择收款银行账号！",function(){window.setTimeout("THISPAGE.triggerChooseBank()",500)}),!1):d}return!1},triggerChooseBank:function(){$("#bankAccountEdit").trigger("click")}},THISPAGE.init()});